# Prerequisites
# Set a SNYK_TOKEN in the pipelines secrets


# pool:
#   # todo: set this you your own pool as applicable.
#   vmImage: ubuntu-latest

pool: sebsnyk.pool

steps:
  - checkout: self
  - task: NodeTool@0
    displayName: Use Node version 16
    inputs:
      versionSpec: 16

  - script: |
      npm install -g snyk snyk-to-html -g
      snyk auth $(SNYK_TOKEN)
    displayName: 'snyk install & auth'

  # snyk code
  - script: snyk code test --sarif-file-output=CodeAnalysisLogs/snyk-code.sarif
    continueOnError: true
    displayName: 'snyk code'

  # snyk open source
  - script: snyk test --sarif-file-output=CodeAnalysisLogs/snyk-open-source.sarif
    continueOnError: true
    displayName: 'snyk'

  # snyk container
  - script: snyk container test sebsnyk/juice-shop --file=Dockerfile --sarif-file-output=CodeAnalysisLogs/snyk-container.sarif
    continueOnError: true
    displayName: 'snyk container'

  # snyk iac
  - script: snyk iac test --sarif-file-output=CodeAnalysisLogs/snyk-iac.sarif
    continueOnError: true
    displayName: 'snyk iac'

  - task: PublishBuildArtifacts@1
    displayName: "Publish Artifact: CodeAnalysisLogs"
    condition: succeededOrFailed()
    inputs:
      PathtoPublish: $(Build.SourcesDirectory)/CodeAnalysisLogs
      ArtifactName: CodeAnalysisLogs
